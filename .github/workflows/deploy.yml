name: Deploy Application

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
        - production

env:
  TF_VERSION: '1.0.0'
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ env.GCP_PROJECT_ID }}
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        export_default_credentials: true

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Configure Docker credentials
      run: gcloud auth configure-docker

    - name: Set environment variables
      run: |
        echo "TF_VAR_db_password=${{ secrets.DB_PASSWORD }}" >> $GITHUB_ENV
        echo "PROJECT_ID=${{ env.GCP_PROJECT_ID }}" >> $GITHUB_ENV
        echo "REGION=northamerica-northeast1" >> $GITHUB_ENV
        echo "CLUSTER_NAME=misinformation-mitigation-gke-cluster" >> $GITHUB_ENV
        echo "IMAGE_NAME=misinformation-mitigation-api" >> $GITHUB_ENV

    - name: Run deploy script
      run: |
        chmod +x ./infrastructure/deploy.sh
        ./infrastructure/deploy.sh
      env:
        ENVIRONMENT: ${{ github.event.inputs.environment }}

    - name: Verify deployment
      run: |
        gcloud container clusters get-credentials ${{ env.CLUSTER_NAME }} --region ${{ env.REGION }} --project ${{ env.GCP_PROJECT_ID }}
        kubectl rollout status deployment/misinformation-mitigation-api -n misinformation-mitigation